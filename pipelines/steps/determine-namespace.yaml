parameters:
  - name: branch
    type: string

  - name: environmentName
    type: string

  - name: trunkBranch
    type: string

steps:
  - checkout: ipaffs-infra

  - task: AzureCLI@2
    name: LoginToContainerRegistry
    displayName: Login to Azure Container Registry
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: az acr login --name $(acrName)

  - task: Kubernetes@1
    name: KubectlLogin
    displayName: Configure Kubernetes client and authenticate
    inputs:
      connectionType: Azure Resource Manager
      azureSubscriptionEndpoint: $(serviceConnection)
      azureResourceGroup: $(resourceGroupName)
      kubernetesCluster: $(kubernetesCluster)
      useClusterAdmin: true
      command: login

  - task: AzureCLI@2
    name: Namespace
    displayName: Determine namespace
    env:
      BRANCH: ${{ parameters.branch }}
      ENVIRONMENT: ${{ parameters.environmentName }}
      TRUNK: ${{ parameters.trunkBranch }}
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptPath: scripts/pipeline/find-namespace-for-branch.sh

# vim: set ts=2 sts=2 sw=2 et:
