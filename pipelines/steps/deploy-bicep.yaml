steps:
  - task: AzureCLI@2
    displayName: WhatIf - Resource Group
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az deployment sub what-if \
          --name "ResourceGroup-$(Build.BuildId)" \
          --location $(location) \
          --template-file bicep/resource-group.bicep \
          --parameters bicep/envs/${{ lower(parameters.environmentName) }}/resource-group.bicepparam

  - task: AzureCLI@2
    displayName: Deploy - ResourceGroup
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az deployment sub create \
          --name "ResourceGroup-$(Build.BuildId)" \
          --location $(location) \
          --template-file bicep/resource-group.bicep \
          --parameters bicep/envs/${{ lower(parameters.environmentName) }}/resource-group.bicepparam

  - task: AzureCLI@2
    displayName: WhatIf - Main
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az deployment group what-if \
          --name "Infrastructure-$(Build.BuildId)" \
          --resource-group $(resourceGroupName) \
          --template-file bicep/main.bicep \
          --parameters bicep/envs/${{ lower(parameters.environmentName) }}/main.bicepparam \
          --parameters tenantId="$(tenantId)"

  - task: AzureCLI@2
    displayName: Deploy - Main
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az deployment group create \
          --name "Infrastructure-$(Build.BuildId)" \
          --resource-group $(resourceGroupName) \
          --template-file bicep/main.bicep \
          --parameters bicep/envs/${{ lower(parameters.environmentName) }}/main.bicepparam \
          --parameters tenantId="$(tenantId)"

  - task: AzureCLI@2
    displayName: Wait for Deployment - Main
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az deployment group wait \
          --name "Infrastructure-$(Build.BuildId)" \
          --resource-group $(resourceGroupName) \
          --created

  - task: AzureCLI@2
    name: StoreLibraryVars
    displayName: Store Library Variables
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    env:
      ADO_ORG_URL: $(System.CollectionUri)
      ADO_PROJECT: $(System.TeamProject)
      ADO_GROUP_NAME: ${{ parameters.environmentName }}
      DEPLOYMENT_NAME: Infrastructure-$(Build.BuildId)
      RESOURCE_GROUP: $(resourceGroupName)
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        scripts/pipeline/update-group-variable.sh acrLoginServer acrLoginServer
        scripts/pipeline/update-group-variable.sh acrName acrName
        scripts/pipeline/update-group-variable.sh azureServiceOperatorClientId azureServiceOperatorClientId
        scripts/pipeline/update-group-variable.sh aksOidcIssuer aksOidcIssuer
        scripts/pipeline/update-group-variable.sh keyVaultName keyVaultName
        scripts/pipeline/update-group-variable.sh keyVaultUrl keyVaultUri
        scripts/pipeline/update-group-variable.sh kubernetesCluster aksClusterName
        scripts/pipeline/update-group-variable.sh sqlAdminGroupId sqlAdminGroupId
        scripts/pipeline/update-group-variable.sh sqlServerName sqlServerName

# vim: set ts=2 sts=2 sw=2 et:
