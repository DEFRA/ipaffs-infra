parameters:
  - name: namespace
    type: string

  - name: branch
    type: string

  - name: owner
    type: string

steps:
  - task: Kubernetes@1
    name: KubectlGetNamespace
    displayName: Get namespace
    continueOnError: true
    inputs:
      connectionType: Azure Resource Manager
      azureSubscriptionEndpoint: $(serviceConnection)
      azureResourceGroup: $(resourceGroupName)
      kubernetesCluster: $(kubernetesCluster)
      useClusterAdmin: true
      command: get
      arguments: namespace ${{ parameters.namespace }}

  - task: Kubernetes@1
    name: KubectlCreateNamespace
    displayName: Create namespace
    condition: failed()
    inputs:
      connectionType: Azure Resource Manager
      azureSubscriptionEndpoint: $(serviceConnection)
      azureResourceGroup: $(resourceGroupName)
      kubernetesCluster: $(kubernetesCluster)
      useClusterAdmin: true
      command: create
      arguments: namespace ${{ parameters.namespace }}

  - task: Bash@3
    name: EncodeBranchName
    displayName: Encode branch name
    inputs:
      targetType: inline
      script:
        owner="$(echo -n "${{ parameters.branch }}" | base64)"
        echo "##vso[task.setvariable variable=branch]${branch}"

  - task: Bash@3
    name: DetermineOwner
    displayName: Determine owner
    inputs:
      targetType: inline
      script:
        owner="$(echo "${{ parameters.owner }}" | sed 's/[^a-zA-Z0-9._-]/_/g' | cut -c1-63)"
        echo "##vso[task.setvariable variable=owner]${owner}"

  - task: Kubernetes@1
    name: KubectlLabelNamespace
    displayName: Label namespace
    inputs:
      connectionType: Azure Resource Manager
      azureSubscriptionEndpoint: $(serviceConnection)
      azureResourceGroup: $(resourceGroupName)
      kubernetesCluster: $(kubernetesCluster)
      useClusterAdmin: true
      command: label
      arguments: namespace ${{ parameters.namespace }} "defra.gov.uk/branch=$(branch)" "defra.gov.uk/owner=$(owner)" --overwrite=true

# vim: set ts=2 sts=2 sw=2 et:
