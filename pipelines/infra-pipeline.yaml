trigger:
  branches:
    include:
      - main
  paths:
    include:
      - bicep/**
      - pipelines/infra-pipeline.yaml

pr:
  - main

pool:
  name: DEFRA-COMMON-ubuntu2204-SSV5

variables:
  azureSubscription: ADO-DefraGovUK-AZR-POC_IMP # Name of service connection
  resourceGroupName: POCIMPNETNS1401
  location: UKSouth

parameters:
- name: bicep_files
  type: stringList
  values:
    - virtual-network
    - network-security-group
    - acr
    - aks-cluster
  default:
    - virtual-network
    - network-security-group
    - acr
    - aks-cluster
- name: charts
  type: object
  default:
    - name: ingress-nginx
      release: ingress-nginx
      chartName: ingress-nginx
      repoUrl: https://kubernetes.github.io/ingress-nginx
      namespace: ingress-nginx
      valuesFile: helm-charts/ingress-nginx-values.yaml

stages:
  - stage: DeployBaseInfrastructure
    jobs:
      - job: Deploy
        steps:
          - task: AzureCLI@2
            name: PrepareResourceGroups
            condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az group create \
                  --name $(resourceGroupName) \
                  --location $(location)

          - ${{ each template in parameters.bicep_files }}:
            - task: AzureCLI@2
              displayName: WhatIf_${{ template }}
              condition: ne(variables['Build.SourceBranch'], 'refs/heads/main')
              inputs:
                azureSubscription: $(azureSubscription)
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  az deployment group what-if \
                    --name "${{ template }}-$(Build.BuildId)" \
                    --resource-group $(resourceGroupName) \
                    --template-file bicep/${{ template }}.bicep \
                    --parameters @bicep/envs/poc/${{ template }}.parameters.json

            - task: AzureCLI@2
              displayName: Deploy_${{ template }}
              condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
              inputs:
                azureSubscription: $(azureSubscription)
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  az deployment group create \
                    --name "${{ template }}-$(Build.BuildId)" \
                    --resource-group $(resourceGroupName) \
                    --template-file bicep/${{ template }}.bicep \
                    --parameters @bicep/envs/poc/${{ template }}.parameters.json

          - ${{ each chart in parameters.charts }}:
            - task: HelmDeploy@0
              displayName: "HelmInstall_${{ chart.release }}"
              condition: ne(variables['Build.SourceBranch'], 'refs/heads/main')
              inputs:
                connectionType: Azure Resource Manager
                azureSubscription: $(azureSubscription)
                azureResourceGroup: $(resourceGroupName)
                kubernetesCluster: POCIMPINFAK1401
                namespace: ${{ chart.namespace }}
                command: upgrade
                chartName: ${{ chart.chartName }}
                releaseName: ${{ chart.release }}
                install: true
                useClusterAdmin: true
                arguments: >-
                  --repo https://kubernetes.github.io/ingress-nginx
                  -f ${{ chart.valuesFile }}
                  --create-namespace
                  --dry-run

            - task: HelmDeploy@0
              displayName: "HelmInstall_${{ chart.release }}"
              condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
              inputs:
                connectionType: Azure Resource Manager
                azureSubscription: $(azureSubscription)
                azureResourceGroup: $(resourceGroupName)
                kubernetesCluster: POCIMPINFAK1401
                namespace: ${{ chart.namespace }}
                command: upgrade
                chartName: ${{ chart.chartName }}
                releaseName: ${{ chart.release }}
                install: true
                useClusterAdmin: true
                arguments: >-
                  --repo https://kubernetes.github.io/ingress-nginx
                  -f ${{ chart.valuesFile }}
                  --create-namespace