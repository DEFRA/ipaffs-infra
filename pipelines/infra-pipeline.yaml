trigger:
  branches:
    include:
      - main

pool:
  name: DEFRA-COMMON-ubuntu2204-SSV5

variables:
  azureSubscription: 'ADO-DefraGovUK-AZR-POC_IMP' # Name of service connection
  resourceGroupName: 'POCIMPINFRG1401'
  networkresourceGroupName: 'POCIMPNETNS1401'
  location: 'UKSouth'

parameters:
- name: network
  type: object
  default:
    - virtual-network
    - network-security-group
- name: infra
  type: object
  default:
    - aks-cluster
- name: charts
  type: object
  default:
    - name: api
      release: api
      chartPath: charts/api
      namespace: api
      values: helm-values/api.yaml

stages:
  - stage: DeployBaseInfrastructure
    jobs:
      - job: Deploy
        steps:
          - task: AzureCLI@2
            name: PrepareResourceGroups
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az group create \
                  --name $(networkresourceGroupName) \
                  --location $(location)
          

          - ${{ each template in parameters.network }}:
            - task: AzureCLI@2
              displayName: Deloy_${{ template }}
              condition: ne(variables['Build.SourceBranch'], 'refs/heads/main')
              inputs:
                azureSubscription: $(azureSubscription)
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  az deployment group create \
                    --name "${{ replace(template, '.bicep', '') }}-$(Build.BuildId)" \
                    --resource-group $(networkresourceGroupName) \
                    --template-file bicep/${{ template }}.bicep \
                    --parameters @bicep/envs/poc/${{ template }}.parameters.json
          
          - ${{ each template in parameters.infra }}:
            - task: AzureCLI@2
              displayName: Deloy_${{ template }}
              condition: ne(variables['Build.SourceBranch'], 'refs/heads/main')
              inputs:
                azureSubscription: $(azureSubscription)
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  az deployment group create \
                    --name "${{ replace(template, '.bicep', '') }}-$(Build.BuildId)" \
                    --resource-group $(resourceGroupName) \
                    --template-file bicep/${{ template }}.bicep \
                    --parameters @bicep/envs/poc/${{ template }}.parameters.json

            ${{ each c in parameters.charts }}:
            - task: HelmDeploy@0
              displayName: "helm upgrade --install ${{ c.release }}"
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscription: $(azureSubscription)
                azureResourceGroup: $(resourceGroupName)
                kubernetesCluster: $(aksClusterName)
                namespace: ${{ coalesce(c.namespace, variables.defaultNamespace) }}
                command: 'upgrade'
                chartType: 'FilePath'
                chartPath: ${{ c.chartPath }}
                releaseName: ${{ c.release }}
                install: true
                arguments: >-
                  --values ${{ c.values }}
                  --history-max 5
                  --atomic
                  --timeout 5m

