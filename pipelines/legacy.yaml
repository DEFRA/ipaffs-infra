---
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - bicep/90-legacy.bicep
      - bicep/**/90-legacy.bicepparam
      - pipelines/legacy.yaml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - bicep/90-legacy.bicep
      - bicep/**/90-legacy.bicepparam
      - pipelines/legacy.yaml

pool:
  name: DEFRA-COMMON-ubuntu2204-SSV5

parameters:
  - name: environmentName
    displayName: Environment
    type: string
    default: SND
    values:
      - SND
      - TST
      - PRE
      - PRD

variables:
  - group: "${{ parameters.environmentName }}"
  - template: "vars/common.yaml"
  - template: "vars/${{ lower(parameters.environmentName) }}.yaml"

stages:
  - stage: DeployInfrastructure
    displayName: Deploy Infrastructure
    jobs:
      - deployment: DeployBicep
        displayName: Deploy Bicep Templates
        environment:
          name: "${{ parameters.environmentName }}"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: WhatIf - Legacy
                  inputs:
                    azureSubscription: $(legacyServiceConnection)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az deployment group what-if \
                        --name "Legacy-$(Build.BuildId)" \
                        --subscription $(legacySubscriptionId) \
                        --resource-group $(legacyResourceGroupName) \
                        --template-file bicep/90-legacy.bicep \
                        --parameters bicep/envs/${{ lower(parameters.environmentName) }}/90-legacy.bicepparam

                - task: AzureCLI@2
                  displayName: Deploy - Legacy
                  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
                  inputs:
                    azureSubscription: $(legacyServiceConnection)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az deployment group create \
                        --name "Legacy-$(Build.BuildId)" \
                        --subscription $(legacySubscriptionId) \
                        --resource-group $(legacyResourceGroupName) \
                        --template-file bicep/90-legacy.bicep \
                        --parameters bicep/envs/${{ lower(parameters.environmentName) }}/90-legacy.bicepparam

# vim: set ts=2 sts=2 sw=2 et:
